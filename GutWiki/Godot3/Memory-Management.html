<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link id="maincss" rel="stylesheet" href="github-markdown.css">
    <link rel="stylesheet" href="exported_wiki.css">
</head>


<body>

<!------------------------------------------------------------------------->
<!-- THE TOC STARTS HERE                                                 -->
<!------------------------------------------------------------------------->

    <div id="toc" class="w3-sidebar w3-border-right">
        <div class="markdown-body">
            <embed>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Gut Wiki</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="github-markdown.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Gut Wiki</h1>
</header>
<h3 id="741-godot-3x">7.4.1 (Godot 3.x)</h3>
<ul>
<li><a href="Asserts-and-Methods.html">Asserts-and-Methods</a></li>
<li><a href="Command-Line.html">Command-Line</a></li>
<li><a href="Comparing-Things.html">Comparing-Things</a></li>
<li><a href="Contributing.html">Contributing</a></li>
<li><a href="Creating-Tests.html">Creating-Tests</a></li>
<li><a href="Doubles.html">Doubles</a></li>
<li><a href="Export-Test-Results.html">Export-Test-Results</a></li>
<li><a
href="Gut-Settings-And-Methods.html">Gut-Settings-And-Methods</a></li>
<li><a href="Home.html">Home</a></li>
<li><a href="Hooks.html">Hooks</a></li>
<li><a href="Inner-Test-Classes.html">Inner-Test-Classes</a></li>
<li><a href="Input-Factory.html">Input-Factory</a></li>
<li><a href="Install.html">Install</a></li>
<li><a href="Memory-Management.html">Memory-Management</a></li>
<li><a href="Mock-Input.html">Mock-Input</a></li>
<li><a href="Orphans.html">Orphans</a></li>
<li><a href="Parameterized-Tests.html">Parameterized-Tests</a></li>
<li><a href="Partial-Doubles.html">Partial-Doubles</a></li>
<li><a href="Quick-Start.html">Quick-Start</a></li>
<li><a href="Running-On-Devices.html">Running-On-Devices</a></li>
<li><a href="Simulate.html">Simulate</a></li>
<li><a href="Spies.html">Spies</a></li>
<li><a href="Stubbing.html">Stubbing</a></li>
<li><a href="Tutorials.html">Tutorials</a></li>
<li><a href="Yielding.html">Yielding</a></li>
</ul>
</body>
</html>

            </embed>
        </div>
    </div>


<!------------------------------------------------------------------------->
<!-- THE PAGE STARTS HERE                                                -->
<!------------------------------------------------------------------------->
    <div class="wiki-div">
        <div class="markdown-body">
            <embed>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Memory-Management</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="github-markdown.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Memory-Management</h1>
</header>
<h1 id="overview">Overview</h1>
<p>You may have noticed errors similar to this at the end of your
run:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ERROR:</span> ~List: Condition <span class="st">&quot;_first != __null&quot;</span> is true.</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>   <span class="ex">At:</span> ./core/self_list.h:112.</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> cleanup: ObjectDB Instances still exist!</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>   <span class="ex">At:</span> core/object.cpp:2071.</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ERROR:</span> clear: Resources Still in use at Exit!</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   <span class="ex">At:</span> core/resource.cpp:476.</span></code></pre></div>
<p>These indicate that when the tests finished running there were
existing objects that had not been freed. As of 7.0.0 GUT no longer
causes any leaks on its own.</p>
<p>Starting in 7.0.0 GUT also provides utilities for tracking down
memory leaks and managing test objects. These features include:</p>
<ul>
<li>Printing the count of orphans created by a test</li>
<li>Methods to ease freeing objects
<ul>
<li><code>autofree</code></li>
<li><code>autoqfree</code></li>
<li><code>add_child_autofree</code></li>
<li><code>add_child_autoqfree</code></li>
</ul></li>
</ul>
<p>At the <a href="#memory_mgmt">bottom of the page</a> is my attempt to
describe how Godot does memory management. If any of these sections seem
confusing, read that part first. The <a
href="https://docs.godotengine.org/en/stable/getting_started/scripting/gdscript/gdscript_basics.html#memory-management">Godot
docs</a> have some infomration. Also, here's a <a
href="https://www.youtube.com/watch?v=cl2PxGkpJdo">tutorial</a> on
memory management I found.</p>
<h1 id="gut-orphan-count">GUT Orphan Count</h1>
<p>GUT, by default, will print a count of any orphans that are created
by a test. Depending on the log level these counts will appear after
each test or may just appear after each script. GUT counts the orphans
before each test and warns when the value changes when a test is done.
These counts are summed up for each script as well and a grand total is
printed at the end of the run. You can disable this feature if you want
to.</p>
<p>Godot considers an object to be orphaned if it extends
<code>Object</code> (but not <code>Reference</code>) and has not been
added to the tree. Godot provides the <code>print_stray_nodes</code>
which will print a list of all nodes (and their children) that are not
in the tree. This information is a bit cryptic and can only be printed
to the console and command line. You can also use the
<code>Performance</code> object to get a count of orphans at any
particular time.</p>
<pre><code>var count = Performance.get_monitor(Performance.OBJECT_ORPHAN_NODE_COUNT)</code></pre>
<h1 id="freeing-test-objects">Freeing Test Objects</h1>
<p>Freeing up objects in your tests is tedious. It adds additional lines
of code that don't add anything to the test. To aid in this GUT provides
the <code>autofree</code> and <code>autoqfree</code> functions. Anything
passed to these methods will be freed up after the test runs. These
methods also <code>return</code> whatever is passed into them so you can
chain them together to cut down on space.</p>
<pre><code>var Foo = load(&#39;res://foo.gd&#39;)
var node = autofree(Node.new())
var bar_scene = autofree(load(&#39;res://bar.tscn&#39;).instance())
assert_null(autofree(Foo.new()).get_value(), &#39;default value is null&#39;)</code></pre>
<p><code>autofree</code> will call <code>free</code> on the object (if
it is valid to) at the end of the test. <code>autoqfree</code> will call
<code>queue_free</code> on the object at the end of the test. These
objects are freed before the orphans are counted and will now show up in
the count. If <code>autoqfree</code> is called at anytime during a test
GUT will pause briefly to give the <code>queue_free</code> time to
execute, then it will count orphans.</p>
<p>These functions can be used in a test or the <code>before_each</code>
but should NOT be used in <code>before_all</code>. If you create an
object in <code>before_all</code> you must free it yourself in
<code>after_all</code>. Using either flavor of <code>autofree</code> in
<code>before_all</code> will cause the object to be freed after the
first test is run.</p>
<h1 id="using-add_child-in-tests">Using <code>add_child</code> in
Tests</h1>
<p>When you call <code>add_child</code> from within a test the object is
added as a child of the test script. The test script is a child of the
GUT gui. Any child you add to a test will not be freed until the end of
the test run. GUT holds onto the test scripts until the end for summary
inforation. GUT will output a warning if a test script has children when
it finishes running.</p>
<p>It is best to free any children you add in a test in that same test.
GUT has two helper functions that will add the child and free the child
after the test. These are <code>add_child_autofree</code> and
<code>add_child_autoqfree</code>. These work the same way as
<code>autofree</code> and <code>autoqfree</code> but take the additional
step of calling <code>add_child</code>. These methods also return
whatever is passed to them so you can cut down on lines of code.</p>
<pre><code>func test_foo():
  var node = add_child_autofree(Node.new())
  var node2 = add_child_autoqfree(Node.new())</code></pre>
<p>These functions can be used in a test or the <code>before_each</code>
but should NOT be used in <code>before_all</code>. If you have an object
you want to add as a child in <code>before_all</code> you must free it
yourself in <code>after_all</code>. Using either flavor of
<code>add_child_autofree</code> in <code>before_all</code> will cause
the object to be freed after the first test is run.</p>
<h1 id="freeing-globals">Freeing Globals</h1>
<p>You can use a <a href="Hooks#postrun">post-run hook</a> to clean up
any global objects you have created. If you are running your tests
through a scene then you may have to recreate these objects if you want
to be able to perform multiple test runs through the GUI. You could use
a <a href="Hooks#prerun">pre-run hook</a> to do this, but it all starts
getting messy at that point.</p>
<h1 id="automatically-freed-objects">Automatically Freed Objects</h1>
<p>To help with freeing up objects GUT will automatically free the
following objects at the end of the test.</p>
<ul>
<li><a href="Doubles.html">Doubles</a></li>
<li><a href="Partial-Doubles.html">Partial Doubles</a></li>
</ul>
<p>Calling <code>autofree</code> with one of these objects, or manually
freeing them yourself will not have any adverse effects.</p>
<h1 id="testing-for-leaks"><a name="testing_for_leaks">Testing for
Leaks</h1>
<p>GUT provides the <code>assert_no_new_orphans</code> method that will
assert that the test has not created any new orphans. Using this can be
a little tricky in complicated test scripts.</p>
<p><code>assert_no_new_orphans</code> strictly validates that at the
time it executes the count of of orphans found is the same as before the
test was run. The "before" count is taken prior to executing
<code>before_each</code>. It is recommended that these types of tests
are done in an <a href="Inner-Test-Classes.html">Inner Test Class</a> or
standalone script where it is less likely that a
<code>before_each</code> or <code>before_all</code> would introduce
orphans causing false positives.</p>
<p><code>assert_no_new_orphans</code> cannot take into account anything
you have called <code>autofree</code> on. For one, it's impossible, and
it wouldn't tell you much since freeing that object could cause
leaks.</p>
<p>A standard memory leak test will create an object, free it, and then
verify that you have not created any new orphans. Based on some bad
practices I've done myself I would advise creating tests with and
without using <code>add_child</code>.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode gdscript"><code class="sourceCode gdscript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># res://test/unit/test_foo.gd</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">extends</span> GutTest</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestLeaks:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">extends</span> GutTest</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> Foo <span class="op">=</span> <span class="bu">load</span>(<span class="st">&#39;res://foo.gd&#39;</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">test_no_leaks</span>():</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> to_free <span class="op">=</span> Foo.<span class="fu">new</span>()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        to_free.<span class="fu">free</span>()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assert_not_new_orphans</span>()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">test_no_leaks_with_add_child</span>():</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> to_free <span class="op">=</span> Foo.<span class="fu">new</span>()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">add_child</span>(to_free)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        to_free.<span class="fu">free</span>()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assert_no_new_orphans</span>()</span></code></pre></div>
<p>If you must use <code>queue_free</code> instead of <code>free</code>
in your test then you will have to pause before asserting that no
orphans have been created. You can do this with <code>yield</code></p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode gdscript"><code class="sourceCode gdscript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">test_no_orphans_queue_free</span>();</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> node <span class="op">=</span> Node.<span class="fu">new</span>()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  node.<span class="fu">queue_free</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert_no_new_orphans</span>(<span class="st">&#39;this will fail&#39;</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">yield</span>(<span class="fu">yield_for</span>(<span class="fl">.2</span>), YIELD)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert_no_new_orphans</span>(<span class="st">&#39;this one passes&#39;</span>)</span></code></pre></div>
<h1 id="godot-memory-management"><a name="memory_mgmt">Godot Memory
Management</h1>
<p>Godot treats <code>Object</code> and <code>Reference</code> instances
differently for memory management. The confusing part is that
<code>Reference</code> extends <code>Object</code>. Most of the time you
don't have to worry about anything that extends <code>Reference</code>.
But if it extends <code>Object</code> (and not <code>Reference</code>)
you must free it yourself or it, and all its parts, will stay around
until you exit the game.</p>
<h4 id="reference">Reference</h4>
<p>Any class/script that extends Reference is managed via reference
counts. As you add variables that "point" to an object, the reference
count increases. As these variables go out of scope or are changed the
reference count is decreased. When the count hits 0, the object is freed
automatically.</p>
<p>For the most part you don't have to worry about this. It just works.
These reference counts can become an indirect leak if you do not free an
<code>Object</code> that has variables pointing to
<code>Reference</code> instances. References can become leaks if there
are cyclical references of objects that prevent each other from being
freed. <code>weakref</code> is useful in these cases. Currently there is
no way to get any additional information about instances of Reference
from the engine.</p>
<pre><code># makes a new Reference object and returns a reference to it.  The reference
# count is now 1
var ref1 = Reference.new() # lets call this [Reference:1]
# Make another variable that &quot;points&quot; to the object above.
var ref1_1 = ref1 # [Reference:1] now has a reference count of 2

if(true):
  var ref_in_if = ref1 # now the count is 3

# now we are back to 2 since ref_in_if went out of scope
print(&#39;out of if&#39;)

ref1_1 = null # the count is now 1
ref1 = null # [Reference:1] will now be freed</code></pre>
<h4 id="weakref">Weakref</h4>
<p>There can be situations where cyclical references will prevent a
<code>Reference</code> from being freed. To help in these situations
Godot has the <a
href="https://docs.godotengine.org/en/stable/classes/class_weakref.html"><code>weakref</code></a>
function.</p>
<p>The <code>weakref</code> function will return you an object that
points to a reference but does not increase the reference count. This
allows you to point at an object without preventing it from being freed
automatically. You must take this into account though and verify that
the object still exists when you want to get the reference back out of
the <code>weakref</code>.</p>
<pre><code>var foo = Foo.new() # where Foo extends Reference
foo.set_bar(&#39;hello world&#39;)
var wref = weakref(foo)

...

# this line increases the reference count until ref_of_wref goes out of scope
var ref_of_wref = wref.get_ref()
if(is_instance_valid(ref_of_wref)):
  print(ref_of_wref.get_bar()) # prints &#39;hello world&#39; if ref hasn&#39;t been freed already.</code></pre>
<h4 id="object-except-reference">Object (except Reference)</h4>
<p>Anything that extends <code>Object</code> (directly or indirectly)
but DOES NOT extend <code>Reference</code> must be freed manually. Any
of these objects that are not in the main tree are considered orphaned.
Any children of these objects are also considered orphans. You can free
these objects by calling <code>free</code> or <code>queue_free</code>.
You can see a list of orphans by using
<code>print_stray_nodes</code>.</p>
</body>
</html>

            </embed>
        </div>
    </div>

</body>

</html>