
        <html><head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            .markdown-body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
            }

            @media (max-width: 767px) {
                .markdown-body {
                    padding: 15px;
                }
            }
        </style>
        <link rel="stylesheet" href="github-markdown.css"/>
</head><body><article class="markdown-body"><h1><a id="user-content-stubbing" class="anchor" aria-hidden="true" href="#stubbing"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stubbing</h1>
<h5><a id="user-content-table-of-contents" class="anchor" aria-hidden="true" href="#table-of-contents"><span aria-hidden="true" class="octicon octicon-link"></span></a>Table of Contents</h5>
<ul>
<li>The Fine Print</li>
<li>Syntax</li>
<li>Stubbing based off of parameter values</li>
<li>Stubbing Packed Scenes</li>
<li>Stubbing Method Paramter Defaults</li>
<li>Stubbing Method Paramter Count</li>
</ul>
<hr>
<p>The <code>stub</code> function allows you to set return values for methods for a doubled script or instance.  You can stub any doubled class to return values.  Stubs can be layered to address general and specific situations.</p>
<p>You can also use <code>stub</code> to set default parameter values and change the parameter count for a method.</p>
<h1><a id="user-content-the-fine-print" class="anchor" aria-hidden="true" href="#the-fine-print"><span aria-hidden="true" class="octicon octicon-link"></span></a>The fine print</h1>
<p>Because of how doubling works, you can only stub methods that are implemented in your script or any scripts that inherits from.  You can stub most built-in methods if you use the experimental FULL doubling strategy.  Check the bottom of the doubling page for more information.</p>
<h1><a id="user-content-syntax" class="anchor" aria-hidden="true" href="#syntax"><span aria-hidden="true" class="octicon octicon-link"></span></a>Syntax</h1>
<pre><code>var inst = double('res://script.gd').new()
stub(inst, 'some_method').to_return("I'm stubbed!")
</code></pre>
<ul>
<li>
<code>stub(obj, method)</code>  This stubs the value for a method.  You must chain in a call to one of the "to" methods such as <code>to_return(...)</code>.  The first parameter can be a path to a script or a loaded script or an instance of a doubled object.  When you pass in a path or class, then all doubles of that script will have the stub by default.  You can override this by calling <code>stub</code> on an instance of a doubled object.</li>
</ul>
<p>After calling <code>stub</code> you must chain one of the following "to" methods after.</p>
<ul>
<li>
<code>.to_return(value)</code> Stubs the method to return the passed value.</li>
<li>
<code>.to_call_super()</code>  This will cause the method to punch through to the implementation in the super class so it will retain its original functionality.</li>
<li>
<code>.to_do_nothing()</code>  This is the same as calling <code>.to_return(null)</code> but it is more readable and shows the intent of what you are doing.</li>
</ul>
<p>You can optionally chain in the <code>when_passed</code> clause as well.</p>
<ul>
<li>
<code>.when_passed(p1, p2, p3....p10)</code>  This can optionally be called on the result of <code>stub</code> in order to stub a value when specific parameters are passed to the method.  It supports up to 10 parameters.  Let me know if you need more.  For example:</li>
</ul>
<pre><code>stub('res://script.gd', 'method').to_return(-5).when_passed('minus', 'five')
</code></pre>
<p>You can also alter a method's signature with</p>
<ul>
<li><code>.param_defaults([])</code></li>
<li>
<code>.param_count(x)</code>
See below for more information about setting parameter default values and changing parameter counts.</li>
</ul>
<h2><a id="user-content-example" class="anchor" aria-hidden="true" href="#example"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example</h2>
<p>Here is a simple example</p>
<p>Given the <code>double_this</code> class:</p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-c"><span class="pl-c">#</span> res://scripts/double_this.gd</span>
<span class="pl-k">extends</span><span class="pl-e"> Node2D</span>

<span class="pl-k">var</span> foo <span class="pl-k">=</span> -<span class="pl-c1">1</span>
<span class="pl-k">var</span> bar <span class="pl-k">=</span> <span class="pl-c1">10</span>

<span class="pl-k">func</span> <span class="pl-en">return_seven</span>():
  <span class="pl-k">return</span> <span class="pl-c1">7</span>

<span class="pl-k">func</span> <span class="pl-en">return_hello</span>(<span class="pl-smi">param</span><span class="pl-k">=</span><span class="pl-c1">1</span>):
  <span class="pl-k">return</span> <span class="pl-s">'hello'</span>

<span class="pl-k">class</span> <span class="pl-en">InnerClass</span>:
  <span class="pl-k">var</span> another_foo <span class="pl-k">=</span> <span class="pl-c1">100</span></pre></div>
<p>Then, from inside your test script you can do the following to alter the <code>return_seven</code> method to return <code>500</code></p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-k">func</span> <span class="pl-en">test_something</span>():
  <span class="pl-k">var</span> inst <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-s">'res://scripts/double_this.gd'</span>).<span class="pl-c1">new</span>()
  <span class="pl-c1">stub</span>(<span class="pl-s">'res://scripts/double_this.gd'</span>, <span class="pl-s">'return_seven'</span>).<span class="pl-c1">to_return</span>(<span class="pl-c1">500</span>)
  <span class="pl-c1">assert_eq</span>(inst.<span class="pl-c1">return_seven</span>(), <span class="pl-c1">500</span>)</pre></div>
<p>The <code>stub</code> method is pretty smart about what you pass it.  You can pass it a path, an Object or an instance.  If you pass an instance, it <strong>must</strong> be an instance of a double.</p>
<p>When passed an Object or a path, it will stub the value for <strong>all</strong> instances that do not have explicitly defined stubs.  When you pass it an instance of a doubled class, then the stubbed return will only be set for that instance.</p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-k">var</span> <span class="pl-c1">DoubleThis</span> <span class="pl-k">=</span> <span class="pl-c1">load</span>(<span class="pl-s">'res://scripts/double_this.gd'</span>)
<span class="pl-k">var</span> <span class="pl-c1">Doubled</span> <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-s">'res://scripts/double_this.gd'</span>)

<span class="pl-c"><span class="pl-c">#</span> these two are equivalent</span>
<span class="pl-c1">stub</span>(<span class="pl-s">'res://scripts/double_this.gd'</span>, <span class="pl-s">'return_seven'</span>).<span class="pl-c1">to_return</span>(<span class="pl-c1">500</span>)
<span class="pl-c1">stub</span>(<span class="pl-c1">DoubleThis</span>, <span class="pl-s">'return_seven'</span>).<span class="pl-c1">to_return</span>(<span class="pl-c1">500</span>)

<span class="pl-c"><span class="pl-c">#</span> This will stub the value for the passed in instance ONLY.</span>
<span class="pl-c"><span class="pl-c">#</span> Any other instances will return 500 from the lines above.</span>
<span class="pl-k">var</span> doubled_inst <span class="pl-k">=</span> <span class="pl-c1">Doubled</span>.<span class="pl-c1">new</span>()
<span class="pl-c1">stub</span>(doubled_inst, <span class="pl-s">'return_seven'</span>).<span class="pl-c1">to_return</span>(<span class="pl-s">'words'</span>)</pre></div>
<h1><a id="user-content-stubbing-based-off-of-parameter-values" class="anchor" aria-hidden="true" href="#stubbing-based-off-of-parameter-values"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stubbing based off of parameter values</h1>
<p>You can stub a method to return a specific value based on what was passed in.</p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-k">const</span> <span class="pl-c1">DOUBLE_THIS_PATH</span> <span class="pl-k">=</span> <span class="pl-s">'res://scripts/double_this.gd'</span>
<span class="pl-k">var</span> <span class="pl-c1">Doubled</span> <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-c1">DOUBLE_THI_PATH</span>)
<span class="pl-c1">stub</span>(<span class="pl-c1">DOUBLE_THIS_PATH</span>, <span class="pl-s">'return_hello'</span>).<span class="pl-c1">to_return</span>(<span class="pl-s">'world'</span>).<span class="pl-c1">when_passed</span>(<span class="pl-c1">7</span>)</pre></div>
<p>The ordering of <code>when_passed</code> and <code>to_return</code> does not matter.</p>
<h1><a id="user-content-stubbing-packed-scenes" class="anchor" aria-hidden="true" href="#stubbing-packed-scenes"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stubbing Packed Scenes</h1>
<p>When stubbing doubled scenes, use the path to the scene, <strong>not</strong> the path to the scene's script.  If you double and stub the script used by the scene, the <code>instance</code> you make from <code>double_scene</code> will not return values stubbed for the script.  It will only return values stubbed for the scene.</p>
<p>In order for a scene to be doubled, the scene's script must be able to be instantiated with <code>new</code> with zero parameters passed.</p>
<h2><a id="user-content-example-1" class="anchor" aria-hidden="true" href="#example-1"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example</h2>
<p>Given the script <code>res://the_script.gd</code>:</p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-k">func</span> <span class="pl-en">return_hello</span>():
  <span class="pl-k">return</span> <span class="pl-s">'hello'</span></pre></div>
<p>And given a scene with the path <code>res://double_this_scene.tscn</code> which has its script set to <code>res://the_script.gd</code>.</p>
<p>The following asserts will pass</p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-k">func</span> <span class="pl-en">test_illustrate_stubbing_scenes</span>():
  <span class="pl-k">const</span> <span class="pl-c1">SCENE_PATH</span> <span class="pl-k">=</span> <span class="pl-s">'res://double_this_scene.tscn'</span>
  <span class="pl-k">const</span> <span class="pl-c1">SCRIPT_PATH</span> <span class="pl-k">=</span> <span class="pl-s">'res://the_script.gd'</span>

  <span class="pl-k">var</span> scene <span class="pl-k">=</span> <span class="pl-c1">double_scene</span>(<span class="pl-c1">SCENE_PATH</span>).<span class="pl-c1">instance</span>()
  <span class="pl-k">var</span> script <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-c1">SCRIPT_PATH</span>).<span class="pl-c1">new</span>()

  <span class="pl-c1">stub</span>(<span class="pl-c1">SCENE_PATH</span>, <span class="pl-s">'return_hello'</span>).<span class="pl-c1">to_return</span>(<span class="pl-s">'world'</span>)
  <span class="pl-c1">stub</span>(<span class="pl-c1">SCRIPT_PATH</span>, <span class="pl-s">'return_hello'</span>).<span class="pl-c1">to_return</span>(<span class="pl-s">'goodbye'</span>)

  <span class="pl-c1">assert_eq</span>(scene.<span class="pl-c1">return_hello</span>(), <span class="pl-s">'world'</span>)
  <span class="pl-c1">assert_eq</span>(script.<span class="pl-c1">return_hello</span>(), <span class="pl-s">'goodbye'</span>)</pre></div>
<h1><a id="user-content-stubbing-method-paramter-defaults" class="anchor" aria-hidden="true" href="#stubbing-method-paramter-defaults"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stubbing Method Paramter Defaults</h1>
<p>Godot only provides information about default values for built in methods so Gut doesn't know what any default values are for methods you have created.  Since it can't know, Gut defaults all parameters to <code>null</code>.  This can cause issues in specific cases (probably all invovling calling super).  You can use <code>.param_defaults</code> to specify default values to be used.</p>
<p>Here's an example where things go wrong</p>
<pre><code># res://foo.gd
var _sum  = 0
func increment(inc_by=1):
  _sum += inc_by

func go_up_one():
  increment()

func get_sum():
  return _sum
</code></pre>
<p>The following test will cause a <code>Invalid operands 'int' and 'Nil'</code> error.  This is because increment's <code>inc_by</code> parameter is defaulted to <code>null</code> in the double.</p>
<pre><code>var Foo = load('res://foo.gd')
test_go_up_one_increments_sum_by_1():
  var dbl_foo = double(Foo).new()
  stub(dbl_foo, 'go_up_one').to_call_super()

  dbl_foo.go_up_one()
  assert_called(dbl_foo, 'increment', [1])
</code></pre>
<p>The fix is to add a <code>param_defaults</code> stub</p>
<pre><code>stub(dbl_foo, 'increment').param_defaults([1])
</code></pre>
<h1><a id="user-content-stubbing-method-paramter-count" class="anchor" aria-hidden="true" href="#stubbing-method-paramter-count"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stubbing Method Paramter Count</h1>
<p><strong>Changing the number of parameters must be done before <code>double</code> is called</strong></p>
<p>Some built-in methods  have <code>vararg</code> parameters.  This makes the paramter list dynamic.  Godot does not provide this information.  This can cause errors due to a signature mismatch.  Your code might be calling a method using 10 parameter values but Gut only sees two.</p>
<p>Let's take <code>Node.rpc_id</code> for example.  It has two normal parameters and then a vararg of strings as the last paramter.</p>
<pre><code>Variant rpc_id(peer_id: int, method: String, ...) vararg
</code></pre>
<p>If this method gets called in a parital double with more than 2 parameters Godot will will throw <em>Invalid call to function 'rpc_id' in base 'Control ()'. Expected 2 arguments.</em></p>
<p>You can use <code>.param_count(x)</code> to tell Gut to give the method any number of extra parameters.  You cannot make the method have less parameters.  You must do this before you call <code>double</code>.</p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-k">func</span> <span class="pl-en">test_issue_246_rpc_id_varargs</span>():
  <span class="pl-c"><span class="pl-c">#</span> must happen before double is called</span>
  <span class="pl-c1">stub</span>(<span class="pl-c1">Node</span>, <span class="pl-s">'rpc_id'</span>).<span class="pl-c1">to_do_nothing</span>().<span class="pl-c1">param_count</span>(<span class="pl-c1">5</span>)

  <span class="pl-k">var</span> inst <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-c1">Node</span>).<span class="pl-c1">new</span>()
  inst.<span class="pl-c1">rpc_id</span>(<span class="pl-c1">1</span>, <span class="pl-s">'foo'</span>, <span class="pl-s">'3'</span>, <span class="pl-s">'4'</span>, <span class="pl-s">'5'</span>)
  <span class="pl-c1">assert_called</span>(inst, <span class="pl-s">'rpc_id'</span>, [<span class="pl-c1">1</span>, <span class="pl-s">'foo'</span>, <span class="pl-s">'3'</span>, <span class="pl-s">'4'</span>, <span class="pl-s">'5'</span>])</pre></div>
<p>You can also use <code>.param_defaults</code> to specify extra parameters if you supply more defaults than the method has parameters.</p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-k">func</span> <span class="pl-en">test_issue_246_rpc_id_varargs_with_defaults</span>():
  <span class="pl-c"><span class="pl-c">#</span> must happen before double is called</span>
  <span class="pl-c1">stub</span>(<span class="pl-c1">Node</span>, <span class="pl-s">'rpc_id'</span>).<span class="pl-c1">to_do_nothing</span>().<span class="pl-c1">param_defaults</span>([<span class="pl-c1">null</span>, <span class="pl-c1">null</span>, <span class="pl-s">'a'</span>, <span class="pl-s">'b'</span>, <span class="pl-s">'c'</span>])

  <span class="pl-k">var</span> inst <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-c1">Node</span>).<span class="pl-c1">new</span>()
  inst.<span class="pl-c1">rpc_id</span>(<span class="pl-c1">1</span>, <span class="pl-s">'foo'</span>, <span class="pl-s">'z'</span>)
  <span class="pl-c1">assert_called</span>(inst, <span class="pl-s">'rpc_id'</span>, [<span class="pl-c1">1</span>, <span class="pl-s">'foo'</span>, <span class="pl-s">'z'</span>, <span class="pl-s">'b'</span>, <span class="pl-s">'c'</span>])</pre></div>
<p>You cannot make a method have less parameters, only more.</p>
</article></body>