
        <html><head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            .markdown-body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
            }

            @media (max-width: 767px) {
                .markdown-body {
                    padding: 15px;
                }
            }
        </style>
        <link rel="stylesheet" href="github-markdown.css"/>
</head><body><article class="markdown-body"><h1><a id="user-content-spies" class="anchor" aria-hidden="true" href="#spies"><span aria-hidden="true" class="octicon octicon-link"></span></a>Spies</h1>
<p>When a <code>double</code> is instanced, Gut will record calls to methods that are defined in the script or scripts it inherits from.  You can then make assertions to check if a method was called, not called, passed certain values, or how many times it was called.</p>
<p>You should read the page on doubling before using this, as there are some gotchas with doubling.</p>
<p>The following methods can be used to "spy" on doubled objects:</p>
<ul>
<li><code>assert_called</code></li>
<li><code>assert_not_called</code></li>
<li><code>assert_call_count</code></li>
<li><code>get_call_parameters</code></li>
</ul>
<h4><a id="user-content-assert_calledinst-method_name-parametersnull" class="anchor" aria-hidden="true" href="#assert_calledinst-method_name-parametersnull"><span aria-hidden="true" class="octicon octicon-link"></span></a><a name="user-content-assert_called">assert_called(inst, method_name, parameters=null)</a></h4>
<p>This assertion is is one of the ways Gut implements Spies.  It requires that you pass it an instance of a "doubled" object.  An instance created with <code>double</code> will record when a method it has is called.  You can then make assertions based on this.</p>
<p>This assert will check the object to see if a call to the specified method (optionally with parameters) was called over the course of the test.  If it finds a match this test will <code>pass</code>, if not it will <code>fail</code>.</p>
<p>The <code>parameters</code> parameter is an array of values that you expect to have been passed to <code>method_name</code>.  If you do not specify any parameters then any call to <code>method_name</code> will match and the assert will <code>pass</code>.  If you specify parameters then all the parameter values must match.  You must specify all parameters the method takes, even if they have defaults.  Gut is not able (yet?) to fill in default values.</p>
<p><strong>Methods that are inherited from built-in parent classes are not yet recorded.  For example, you cannot make "called" assertions on methods like <code>set_position</code> unless your sub-class specifically implements it.  But since those methods retain their built-in functionality, you can just make normal assertions on them.</strong></p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-c"><span class="pl-c">#</span> Given the following class located at 'res://test/doubler_test_objects/double_extends_node2d.gd'</span>
<span class="pl-c"><span class="pl-c">#</span> --------------------</span>
	<span class="pl-k">extends</span><span class="pl-e"> Node2D</span>
	<span class="pl-k">var</span> _value <span class="pl-k">=</span> <span class="pl-c1">0</span>

	<span class="pl-k">func</span> <span class="pl-en">get_value</span>():
	    <span class="pl-k">return</span> _value
	<span class="pl-k">func</span> <span class="pl-en">set_value</span>(<span class="pl-smi">val</span>):
	    _value <span class="pl-k">=</span> val
	<span class="pl-k">func</span> <span class="pl-en">has_one_param</span>(<span class="pl-smi">one</span>):
	    <span class="pl-k">pass</span>
	<span class="pl-k">func</span> <span class="pl-en">has_two_params_one_default</span>(<span class="pl-smi">one</span>, <span class="pl-smi">two</span><span class="pl-k">=</span><span class="pl-c1">null</span>):
	    <span class="pl-k">pass</span>
	<span class="pl-k">func</span> <span class="pl-en">get_position</span>():
	    <span class="pl-k">return</span> .<span class="pl-c1">get_position</span>()
<span class="pl-c"><span class="pl-c">#</span> --------------------</span>

<span class="pl-c"><span class="pl-c">#</span> This is how assert_called behaves</span>
<span class="pl-k">func</span> <span class="pl-en">test_assert_called</span>():
	<span class="pl-k">var</span> <span class="pl-c1">DOUBLE_ME_PATH</span> <span class="pl-k">=</span> <span class="pl-s">'res://test/doubler_test_objects/double_extends_node2d.gd'</span>

	<span class="pl-k">var</span> doubled <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-c1">DOUBLE_ME_PATH</span>).<span class="pl-c1">new</span>()
	doubled.<span class="pl-c1">set_value</span>(<span class="pl-c1">4</span>)
	doubled.<span class="pl-c1">set_value</span>(<span class="pl-c1">5</span>)
	doubled.<span class="pl-c1">has_two_params_one_default</span>(<span class="pl-s">'a'</span>)
	doubled.<span class="pl-c1">has_two_params_one_default</span>(<span class="pl-s">'a'</span>, <span class="pl-s">'b'</span>)

	gut.<span class="pl-c1">p</span>(<span class="pl-s">'-- passing --'</span>)
	<span class="pl-c1">assert_called</span>(doubled, <span class="pl-s">'set_value'</span>)
	<span class="pl-c1">assert_called</span>(doubled, <span class="pl-s">'set_value'</span>, [<span class="pl-c1">5</span>])
	<span class="pl-c"><span class="pl-c">#</span> note the passing of `null` here.  Default parameters must be supplied.</span>
	<span class="pl-c1">assert_called</span>(doubled, <span class="pl-s">'has_two_params_one_default'</span>, [<span class="pl-s">'a'</span>, <span class="pl-c1">null</span>])
	<span class="pl-c1">assert_called</span>(doubled, <span class="pl-s">'has_two_params_one_default'</span>, [<span class="pl-s">'a'</span>, <span class="pl-s">'b'</span>])

	gut.<span class="pl-c1">p</span>(<span class="pl-s">'-- failing --'</span>)
	<span class="pl-c1">assert_called</span>(doubled, <span class="pl-s">'get_value'</span>)
	<span class="pl-c1">assert_called</span>(doubled, <span class="pl-s">'set_value'</span>, [<span class="pl-s">'nope'</span>])
	<span class="pl-c"><span class="pl-c">#</span> This fails b/c Gut isn't smart enough to fill in default values for you...</span>
	<span class="pl-c"><span class="pl-c">#</span> ast least not yet.</span>
	<span class="pl-c1">assert_called</span>(doubled, <span class="pl-s">'has_two_params_one_default'</span>, [<span class="pl-s">'a'</span>])
	<span class="pl-c"><span class="pl-c">#</span> This fails with a specific message indicating that you have to pass an</span>
	<span class="pl-c"><span class="pl-c">#</span> instance of a doubled class.</span>
	<span class="pl-c1">assert_called</span>(<span class="pl-c1">GDScript</span>.<span class="pl-c1">new</span>(), <span class="pl-s">'some_method'</span>)</pre></div>
<h4><a id="user-content-assert_not_calledinst-method_name-parametersnull" class="anchor" aria-hidden="true" href="#assert_not_calledinst-method_name-parametersnull"><span aria-hidden="true" class="octicon octicon-link"></span></a><a name="user-content-asssert_not_called">assert_not_called(inst, method_name, parameters=null)</a></h4>
<p>This is the inverse of <code>assert_called</code> and works the same way except, you know, inversely.  Matches are found based on parameters in the same fashion.  If a matching call is found then this assert will <code>fail</code>, if not it will <code>pass</code>.</p>
<h4><a id="user-content-assert_call_countinst-method_name-expected_count-parametersnull" class="anchor" aria-hidden="true" href="#assert_call_countinst-method_name-expected_count-parametersnull"><span aria-hidden="true" class="octicon octicon-link"></span></a><a name="user-content-assert_call_count">assert_call_count(inst, method_name, expected_count, parameters=null)</a></h4>
<p>This assertion is is one of the ways Gut implements Spies.  It requires that you pass it an instance of a "doubled" object.  An instance created with <code>double</code> will record when a method it has is called.  You can then make assertions based on this.</p>
<p>Asserts that a method on a doubled instance has been called a number of times.  If you do not specify any parameters then all calls to the method will be counted.  If you specify parameters, then only those calls that were passed matching values will be counted.</p>
<p>The <code>parameters</code> parameter is an array of values that you expect to have been passed to <code>method_name</code>.  If you do not specify any parameters then any call to <code>method_name</code> will match and the assert will <code>pass</code>.  If you specify parameters then all the parameter values must match.  You must specify all parameters the method takes, even if they have defaults.  Gut is not able (yet?) to fill in default values.</p>
<p><strong>Methods that are inherited from built-in parent classes are not yet recorded.  For example, you cannot make "call" assertions on methods like <code>set_position</code> unless your sub-class specifically implements it (you can, they will just always return 0).  Since those methods retain their built-in functionality, you can just make normal assertions on them.</strong></p>
<div class="highlight highlight-source-gdscript"><pre><span class="pl-c"><span class="pl-c">#</span> Given the following class located at 'res://test/doubler_test_objects/double_extends_node2d.gd'</span>
<span class="pl-c"><span class="pl-c">#</span> --------------------</span>
	<span class="pl-k">extends</span><span class="pl-e"> Node2D</span>
	<span class="pl-k">var</span> _value <span class="pl-k">=</span> <span class="pl-c1">0</span>

	<span class="pl-k">func</span> <span class="pl-en">get_value</span>():
	    <span class="pl-k">return</span> _value
	<span class="pl-k">func</span> <span class="pl-en">set_value</span>(<span class="pl-smi">val</span>):
	    _value <span class="pl-k">=</span> val
	<span class="pl-k">func</span> <span class="pl-en">has_one_param</span>(<span class="pl-smi">one</span>):
	    <span class="pl-k">pass</span>
	<span class="pl-k">func</span> <span class="pl-en">has_two_params_one_default</span>(<span class="pl-smi">one</span>, <span class="pl-smi">two</span><span class="pl-k">=</span><span class="pl-c1">null</span>):
	    <span class="pl-k">pass</span>
	<span class="pl-k">func</span> <span class="pl-en">get_position</span>():
	    <span class="pl-k">return</span> .<span class="pl-c1">get_position</span>()
<span class="pl-c"><span class="pl-c">#</span> --------------------</span>

<span class="pl-c"><span class="pl-c">#</span> This is how assert_call_count behaves</span>
<span class="pl-k">func</span> <span class="pl-en">test_assert_call_count</span>():
	<span class="pl-k">var</span> <span class="pl-c1">DOUBLE_ME_PATH</span> <span class="pl-k">=</span> <span class="pl-s">'res://test/doubler_test_objects/double_extends_node2d.gd'</span>

	<span class="pl-k">var</span> doubled <span class="pl-k">=</span> <span class="pl-c1">double</span>(<span class="pl-c1">DOUBLE_ME_PATH</span>).<span class="pl-c1">new</span>()
	doubled.<span class="pl-c1">set_value</span>(<span class="pl-c1">4</span>)
	doubled.<span class="pl-c1">set_value</span>(<span class="pl-c1">5</span>)
	doubled.<span class="pl-c1">has_two_params_one_default</span>(<span class="pl-s">'a'</span>)
	doubled.<span class="pl-c1">has_two_params_one_default</span>(<span class="pl-s">'a'</span>, <span class="pl-s">'b'</span>)
	doubled.<span class="pl-c1">set_position</span>(<span class="pl-c1">Vector2</span>(<span class="pl-c1">100</span>, <span class="pl-c1">100</span>))

	gut.<span class="pl-c1">p</span>(<span class="pl-s">'-- passing --'</span>)
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'set_value'</span>, <span class="pl-c1">2</span>)
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'set_value'</span>, <span class="pl-c1">1</span>, [<span class="pl-c1">4</span>])
	<span class="pl-c"><span class="pl-c">#</span> note the passing of `null` here.  Default parameters must be supplied.</span>
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'has_two_params_one_default'</span>, <span class="pl-c1">1</span>, [<span class="pl-s">'a'</span>, <span class="pl-c1">null</span>])
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'get_value'</span>, <span class="pl-c1">0</span>)

	gut.<span class="pl-c1">p</span>(<span class="pl-s">'-- failing --'</span>)
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'set_value'</span>, <span class="pl-c1">5</span>)
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'set_value'</span>, <span class="pl-c1">2</span>, [<span class="pl-c1">4</span>])
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'get_value'</span>, <span class="pl-c1">1</span>)
	<span class="pl-c"><span class="pl-c">#</span> This fails with a specific message indicating that you have to pass an</span>
	<span class="pl-c"><span class="pl-c">#</span> instance of a doubled class even though technically the method was called.</span>
	<span class="pl-c1">assert_call_count</span>(<span class="pl-c1">GDScript</span>.<span class="pl-c1">new</span>(), <span class="pl-s">'some_method'</span>, <span class="pl-c1">0</span>)
	<span class="pl-c"><span class="pl-c">#</span> This fails b/c double_extends_node2d does not have it's own implementation</span>
	<span class="pl-c"><span class="pl-c">#</span> of set_position.  The function is supplied by the parent class and these</span>
	<span class="pl-c"><span class="pl-c">#</span> methods are not yet being recorded.</span>
	<span class="pl-c1">assert_call_count</span>(doubled, <span class="pl-s">'set_position'</span>, <span class="pl-c1">1</span>)
</pre></div>
</article></body>